<html>
  <head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7/web3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css">
    <script>
      const CryptoETFABI = [
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_base",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "_uniswapRouter",
          "type": "address"
        },
        {
          "internalType": "address[]",
          "name": "_tokens",
          "type": "address[]"
        },
        {
          "internalType": "uint256[]",
          "name": "_percentage",
          "type": "uint256[]"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "constructor"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "spender",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Approval",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "currentOwner",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "OwnershipTransferred",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "customer",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "usdc",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "cetf",
          "type": "uint256"
        }
      ],
      "name": "Purchase",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address[]",
          "name": "tokens",
          "type": "address[]"
        },
        {
          "indexed": false,
          "internalType": "uint256[]",
          "name": "ratio",
          "type": "uint256[]"
        }
      ],
      "name": "Rebalance",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": false,
          "internalType": "address",
          "name": "customer",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "usdc",
          "type": "uint256"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "cetf",
          "type": "uint256"
        }
      ],
      "name": "Sell",
      "type": "event"
    },
    {
      "anonymous": false,
      "inputs": [
        {
          "indexed": true,
          "internalType": "address",
          "name": "from",
          "type": "address"
        },
        {
          "indexed": true,
          "internalType": "address",
          "name": "to",
          "type": "address"
        },
        {
          "indexed": false,
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "name": "Transfer",
      "type": "event"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "spender",
          "type": "address"
        }
      ],
      "name": "allowance",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "remaining",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "owner",
          "type": "address"
        }
      ],
      "name": "balanceOf",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "balance",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "owner",
      "outputs": [
        {
          "internalType": "address",
          "name": "ownerAddress",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "renounceOwnership",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "totalSupply",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "total",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "newOwner",
          "type": "address"
        }
      ],
      "name": "transferOwnership",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [],
      "name": "name",
      "outputs": [
        {
          "internalType": "string",
          "name": "tokenName",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "symbol",
      "outputs": [
        {
          "internalType": "string",
          "name": "tokenSymbol",
          "type": "string"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "decimals",
      "outputs": [
        {
          "internalType": "uint8",
          "name": "tokenDecimals",
          "type": "uint8"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "base",
      "outputs": [
        {
          "internalType": "address",
          "name": "token",
          "type": "address"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [],
      "name": "tokens",
      "outputs": [
        {
          "internalType": "address[]",
          "name": "token",
          "type": "address[]"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_token",
          "type": "address"
        }
      ],
      "name": "ratio",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "percentage",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "_amount",
          "type": "uint256"
        }
      ],
      "name": "transfer",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_from",
          "type": "address"
        },
        {
          "internalType": "address",
          "name": "_to",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "_amount",
          "type": "uint256"
        }
      ],
      "name": "transferFrom",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "address",
          "name": "_spender",
          "type": "address"
        },
        {
          "internalType": "uint256",
          "name": "_amount",
          "type": "uint256"
        }
      ],
      "name": "approve",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_deadline",
          "type": "uint256"
        }
      ],
      "name": "purchase",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_baseAmount",
          "type": "uint256"
        }
      ],
      "name": "expectedCETF",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "cETF",
          "type": "uint256"
        }
      ],
      "stateMutability": "view",
      "type": "function",
      "constant": true
    },
    {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "_amount",
          "type": "uint256"
        },
        {
          "internalType": "uint256",
          "name": "_deadline",
          "type": "uint256"
        }
      ],
      "name": "sell",
      "outputs": [
        {
          "internalType": "uint256",
          "name": "amount",
          "type": "uint256"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        {
          "internalType": "uint256[]",
          "name": "_percentage",
          "type": "uint256[]"
        }
      ],
      "name": "rebalance",
      "outputs": [
        {
          "internalType": "bool",
          "name": "success",
          "type": "bool"
        }
      ],
      "stateMutability": "nonpayable",
      "type": "function"
    }
  ];
      document.addEventListener('DOMContentLoaded', function(){
        const ethEnabled = () => {
          if (window.ethereum) {
            window.web3 = new Web3(window.ethereum);
            window.ethereum.enable();
            return true;
          }
          return false;
        }
        if(!ethEnabled()){
          alert("web3 not connected! check metamask");
        }
        else if(window.ethereum.networkVersion != 3) {
          alert("change network to ropsten");
        }
        else {
          window.etf = new web3.eth.Contract(CryptoETFABI, "0xC843270e6a2A88A9b7f1377a222515da9C06Cc3C");
          window.tokenA = new web3.eth.Contract(CryptoETFABI, "0x8b65afda82c3ad82c356f75754217578c80bba1b");
          window.tokenB = new web3.eth.Contract(CryptoETFABI, "0x7ec060933ee549112465d669e4ee239ae4927051");
          window.tokenC = new web3.eth.Contract(CryptoETFABI, "0xe4cec046a6d60f94b94c09a1d7891fe675d2196d");

          var tablePurchase = document.getElementById('purchaselogs').getElementsByTagName('tbody')[0];
          var tableSell = document.getElementById('selllogs').getElementsByTagName('tbody')[0];

          let purchaseStamp=0;
          let sellStamp=0;

          window.etf.events.Purchase()
          .on('data', function(event) {
            if(purchaseStamp < event.blockNumber*10000 + event.logIndex){
              // Insert a row in the table at the last row
              const newRow   = tablePurchase.insertRow();

              // Insert a cell in the row at index 0
              const addressCell  = newRow.insertCell(0);

              // Append a text node to the cell
              const address  = document.createTextNode(event.returnValues.customer);
              addressCell.appendChild(address);

              // Insert a cell in the row at index 0
              const cetfCell  = newRow.insertCell(1);

              // Append a text node to the cell
              const cetf  = document.createTextNode(event.returnValues.cetf);
              cetfCell.appendChild(cetf);

              // Insert a cell in the row at index 0
              const baseCell  = newRow.insertCell(2);

              // Append a text node to the cell
              const baseAmount  = document.createTextNode(event.returnValues.usdc);
              baseCell.appendChild(baseAmount);

              purchaseStamp = event.blockNumber*10000 + event.logIndex;
              console.log("PURCHASE : " + purchaseStamp);
            }
            });
          window.etf.events.Sell()
            .on('data', function(event) {
            if(sellStamp < event.blockNumber*10000 + event.logIndex){
              // Insert a row in the table at the last row
              const newRow   = tableSell.insertRow();

              // Insert a cell in the row at index 0
              const addressCell  = newRow.insertCell(0);

              // Append a text node to the cell
              const address  = document.createTextNode(event.returnValues.customer);
              addressCell.appendChild(address);

              // Insert a cell in the row at index 0
              const cetfCell  = newRow.insertCell(1);

              // Append a text node to the cell
              const cetf  = document.createTextNode(event.returnValues.cetf);
              cetfCell.appendChild(cetf);

              // Insert a cell in the row at index 0
              const baseCell  = newRow.insertCell(2);

              // Append a text node to the cell
              const baseAmount  = document.createTextNode(event.returnValues.usdc);
              baseCell.appendChild(baseAmount);
              sellStamp = event.blockNumber*10000 + event.logIndex;
              console.log("SELL : " + sellStamp);
            }
            });
          window.etf.getPastEvents("Purchase", {
            fromBlock:8083779
          },function(error, event){
            event.forEach(x=> {
            if(purchaseStamp < x.blockNumber*10000 + x.logIndex){
              // Insert a row in the table at the last row
              const newRow   = tablePurchase.insertRow();

              // Insert a cell in the row at index 0
              const addressCell  = newRow.insertCell(0);

              // Append a text node to the cell
              const address  = document.createTextNode(x.returnValues.customer);
              addressCell.appendChild(address);

              // Insert a cell in the row at index 0
              const cetfCell  = newRow.insertCell(1);

              // Append a text node to the cell
              const cetf  = document.createTextNode(x.returnValues.cetf);
              cetfCell.appendChild(cetf);

              // Insert a cell in the row at index 0
              const baseCell  = newRow.insertCell(2);

              // Append a text node to the cell
              const baseAmount  = document.createTextNode(x.returnValues.usdc);
              baseCell.appendChild(baseAmount);
              purchaseStamp = x.blockNumber*10000 + x.logIndex;
              console.log("PURCHASE : " + purchaseStamp);
            }

            });
          });
          window.etf.getPastEvents("Sell", {
            fromBlock:8083779
          },function(error, event){
            event.forEach(x=> {
            if(sellStamp < x.blockNumber*10000 + x.logIndex){
              // Insert a row in the table at the last row
              const newRow   = tableSell.insertRow();

              // Insert a cell in the row at index 0
              const addressCell  = newRow.insertCell(0);

              // Append a text node to the cell
              const address  = document.createTextNode(x.returnValues.customer);
              addressCell.appendChild(address);

              // Insert a cell in the row at index 0
              const cetfCell  = newRow.insertCell(1);

              // Append a text node to the cell
              const cetf  = document.createTextNode(x.returnValues.cetf);
              cetfCell.appendChild(cetf);

              // Insert a cell in the row at index 0
              const baseCell  = newRow.insertCell(2);

              // Append a text node to the cell
              const baseAmount  = document.createTextNode(x.returnValues.usdc);
              baseCell.appendChild(baseAmount);
              sellStamp = x.blockNumber*10000 + x.logIndex;
              console.log("SELL : " + sellStamp);
            }
            });
          });

        }
      });

    </script>
  </head>
  <body>
    <nav style="display: flex; align-items: center; justify-content: center;">
      <ul>
        <li><a href="index.html">Home</li>
        <li><a href="status.html">Status</a></li>
        <li>Logs</li>
        <li><a href="admin.html">Admin</a></li>
      </ul>
    </nav>
    <div style="  display: flex; align-items: center; justify-content: center;">
      <form style="height=100%">
        <header>
          <h2> Purchase </h2>
        </header>
        <table id="purchaselogs">
          <thead>
            <th>address</th>
            <th>cetf amount</th>
            <th>baseToken amount</th>
          </thead>
          <tbody>
          </tbody>
        </table>
      </form>
    </div>
    <div style="  display: flex; align-items: center; justify-content: center;">
      <form style="height=100%">
        <header>
          <h2> Sell </h2>
        </header>
        <table id="selllogs">
          <thead>
            <th>address</th>
            <th>cetf amount</th>
            <th>baseToken amount</th>
          </thead>
          <tbody>
          </tbody>
        </table>
      </form>
    </div>
  </body>
</html>
